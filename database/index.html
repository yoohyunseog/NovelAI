<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Database (NDJSON API)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    a { color: #0a58ca; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; align-items: center; }
    label { display: flex; gap: 6px; align-items: center; }
    input[type="text"], input[type="number"] { padding: 8px; }
    button { padding: 8px 12px; border: 1px solid #bbb; background: #f7f7f7; border-radius: 6px; cursor: pointer; }
    button:hover { background: #eee; }
    .muted { color: #666; font-size: 12px; }
    pre { background: #fafafa; border: 1px solid #eee; padding: 12px; border-radius: 6px; max-height: 420px; overflow:auto; }
    .grid { display: grid; gap: 12px; max-width: 960px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; }
  </style>
</head>
<body>
  <h1>Database</h1>
  <div class="grid">
    <div class="card">
      <h3>레코드 추가 (POST /api/log)</h3>
      <div class="row">
        <label>문자열 s <input id="s" type="text" placeholder="예: 입력 문자열" /></label>
        <label>MAX <input id="max" type="number" step="0.000000000000001" placeholder="예: 2.73" /></label>
        <label>MIN <input id="min" type="number" step="0.000000000000001" placeholder="예: 3.07" /></label>
        <button id="btnSave">저장</button>
        <span id="saveStatus" class="muted"></span>
      </div>
      <div class="muted">서버에 NDJSON 한 줄로 저장됩니다: server/data/log.ndjson</div>
    </div>

    <div class="card">
      <h3>최근 레코드 조회 (GET /api/log?n=...)</h3>
      <div class="row">
        <label>갯수 N <input id="n" type="number" min="1" max="5000" value="50" /></label>
        <button id="btnLoad">조회</button>
        <button id="btnClear">화면 비우기</button>
        <span id="loadStatus" class="muted"></span>
      </div>
      <pre id="out">(결과 없음)</pre>
    </div>

    <div class="card">
      <h3>앱으로 이동</h3>
      <p class="muted">BIT_MAX / BIT_MIN 계산 UI</p>
      <p><a href="/bit_ui.html">/bit_ui.html</a></p>
    </div>

    <div class="card">
      <h3>상태/엔드포인트</h3>
      <ul>
        <li>상태: <a href="/health" target="_blank">/health</a></li>
        <li>조회 API: <code>/api/log?n=50</code></li>
        <li>저장 API: <code>POST /api/log</code></li>
      </ul>
    </div>
  </div>

  <script>
  const $s = document.getElementById('s');
  const $max = document.getElementById('max');
  const $min = document.getElementById('min');
  const $btnSave = document.getElementById('btnSave');
  const $saveStatus = document.getElementById('saveStatus');
  const $n = document.getElementById('n');
  const $btnLoad = document.getElementById('btnLoad');
  const $btnClear = document.getElementById('btnClear');
  const $out = document.getElementById('out');
  const $loadStatus = document.getElementById('loadStatus');

  async function saveRecord() {
    $saveStatus.textContent = '저장 중...';
    try {
      const body = {
        t: Date.now(),
        s: $s.value || '',
        max: parseFloat($max.value),
        min: parseFloat($min.value)
      };
      const res = await fetch('/api/log', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const json = await res.json();
      if (!res.ok || !json.ok) throw new Error(json.error || '저장 실패');
      $saveStatus.textContent = '저장됨';
      // 저장 후 바로 최근 조회 갱신
      loadRecords();
    } catch (e) {
      console.error(e);
      $saveStatus.textContent = '실패: ' + String(e);
    }
  }

  function render(items) {
    if (!items || items.length === 0) { $out.textContent = '(결과 없음)'; return; }
    const lines = items.map((h,i) => `${i+1}. t=${new Date(h.t).toLocaleString()} s="${h.s ?? ''}" MAX=${h.max} MIN=${h.min}`);
    $out.textContent = lines.join('\n');
  }

  async function loadRecords() {
    $loadStatus.textContent = '조회 중...';
    try {
      const n = Math.max(1, Math.min(5000, parseInt($n.value) || 50));
      const res = await fetch(`/api/log?n=${n}`);
      const json = await res.json();
      if (!res.ok || !json.ok) throw new Error(json.error || '조회 실패');
      render(json.items || []);
      $loadStatus.textContent = `로드: ${json.items?.length ?? 0}개`;
    } catch (e) {
      console.error(e);
      $loadStatus.textContent = '실패: ' + String(e);
    }
  }

  $btnSave.addEventListener('click', saveRecord);
  $btnLoad.addEventListener('click', loadRecords);
  $btnClear.addEventListener('click', () => { $out.textContent = '(결과 없음)'; $loadStatus.textContent=''; });

  // 초기 자동 조회
  loadRecords();
  </script>
</body>
</html>

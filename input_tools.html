<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>입력 & 계산 도구</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://xn--9l4b4xi9r.com/_8%EB%B9%84%ED%8A%B8/js/bitCalculation.js" defer></script>
</head>
<body>
    <div class="container py-3">
        <!-- 입력 & 계산 (맨 위로 이동) -->
        <div class="row g-3 mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header"><strong>입력 & 계산</strong></div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="textInput" class="form-label">문자를 입력하세요 (입력 시 실시간 계산)</label>
                            <textarea id="textInput" class="form-control" placeholder="예) 안녕하세요 Hello 123&#10;긴 문장이나 소설도 입력할 수 있습니다.&#10;엔터를 누르면 기록에 저장됩니다." autocomplete="off" rows="6"></textarea>
                            <div class="controls mt-2 d-flex align-items-center gap-2 flex-wrap">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="autoSaveToggle" checked />
                                    <label class="form-check-label" for="autoSaveToggle">자동 저장</label>
                                </div>
                                <button id="exportBtn" class="btn btn-sm btn-outline-secondary">내보내기(JSON)</button>
                                <button id="clearBtn" class="btn btn-sm btn-outline-secondary">기록 비우기</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 소설 구성 요약 (GPT AI) -->
        <div class="row g-3 mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>소설 구성 요약 (GPT AI)</strong>
                        <div class="d-flex align-items-center gap-2">
                            <input type="password" id="gptApiKey" class="form-control form-control-sm" style="width: 200px;" placeholder="OpenAI API 키 (sk-...)" />
                            <button id="summarizeBtn" class="btn btn-sm btn-primary">요약 생성</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="summaryStatus" class="small text-muted mb-2"></div>
                        <div id="novelSummary" class="border rounded p-3" style="min-height: 100px; background-color: #f8f9fa;">
                            <div class="text-muted">입력란의 텍스트를 입력한 후 "요약 생성" 버튼을 클릭하세요.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 새 입력란 (소설 아이디어/메모) - 예측 입력값 바로 위로 이동 -->
        <div class="row g-3 mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header"><strong>새 입력란 (소설 아이디어/메모)</strong></div>
                    <div class="card-body">
                        <div class="mb-2">
                            <textarea id="novelIdeaInput" class="form-control" placeholder="예) 다음 장면 아이디어, 인물 감정 변화, 배경 사운드 묘사 등" rows="4"></textarea>
                        </div>
                        <div class="form-text">이 입력은 참고용 메모로만 저장됩니다.</div>
                        <div class="small text-muted" id="notesStatus"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 예측 입력값 -->
        <div class="row g-3 mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header"><strong>예측 입력값</strong></div>
                    <div class="card-body">
                        <div id="inputPredictions" class="border rounded p-2" style="min-height: 56px;">
                            <span class="badge bg-secondary me-2 mb-2">소 (길이 1)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 기록 보기 -->
        <div class="row g-3 mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header"><strong>기록 보기</strong></div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-sm table-bordered table-striped">
                                <thead class="table-light sticky-top" style="background-color: #f8f9fa;">
                                    <tr>
                                        <th style="width: 3%;">#</th>
                                        <th style="width: 12%;">시간</th>
                                        <th style="width: 30%;">입력</th>
                                        <th style="width: 25%;">ASCII_CODES</th>
                                        <th style="width: 10%;">BIT_MAX</th>
                                        <th style="width: 10%;">BIT_MIN</th>
                                        <th style="width: 10%;">출처</th>
                                    </tr>
                                </thead>
                                <tbody id="historyBody"></tbody>
                            </table>
                        </div>
                        <div class="small text-muted" id="historyInfo">기록 0개</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // 간단한 로컬 기록/예측 도구
    (function(){
      const $text = document.getElementById('textInput');
      const $pred = document.getElementById('inputPredictions');
      const $histBody = document.getElementById('historyBody');
      const $histInfo = document.getElementById('historyInfo');
      const $auto = document.getElementById('autoSaveToggle');
      const $export = document.getElementById('exportBtn');
      const $clear = document.getElementById('clearBtn');
      const $memo = document.getElementById('novelIdeaInput');
      const $memoStatus = document.getElementById('notesStatus');
      const $gptApiKey = document.getElementById('gptApiKey');
      const $summarizeBtn = document.getElementById('summarizeBtn');
      const $summaryStatus = document.getElementById('summaryStatus');
      const $novelSummary = document.getElementById('novelSummary');

      let history = [];

      // 서버 URL 가져오기
      function getServerUrl(path) {
        if (window.location.protocol === 'file:') {
          return `http://localhost:8123${path}`;
        }
        return path;
      }

      // API 키 저장/로드
      try {
        const savedKey = localStorage.getItem('input_tools:gptApiKey');
        if (savedKey) $gptApiKey.value = savedKey;
      } catch {}
      $gptApiKey.addEventListener('blur', () => {
        try {
          localStorage.setItem('input_tools:gptApiKey', $gptApiKey.value || '');
        } catch {}
      });

      // GPT 요약 생성
      async function generateSummary() {
        const inputText = $text.value.trim();
        if (!inputText) {
          $summaryStatus.textContent = '입력란에 텍스트를 입력하세요.';
          $summaryStatus.style.color = '#dc3545';
          return;
        }

        const apiKey = $gptApiKey.value.trim();
        if (!apiKey) {
          $summaryStatus.textContent = 'OpenAI API 키를 입력하세요.';
          $summaryStatus.style.color = '#dc3545';
          return;
        }

        try {
          $summarizeBtn.disabled = true;
          $summaryStatus.textContent = '요약 생성 중...';
          $summaryStatus.style.color = '#007bff';
          $novelSummary.innerHTML = '<div class="text-muted">분석 중...</div>';

          // 먼저 API 키를 서버에 저장
          await fetch(getServerUrl('/api/gpt/key'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ key: apiKey })
          });

          // 소설 구성 카테고리로 요약 요청
          const systemMessage = `당신은 소설 분석 전문가입니다. 주어진 텍스트를 소설 구성에 필요한 카테고리 정보로 체계적으로 요약해주세요.

다음 카테고리로 분류하여 요약하세요:
1. 등장인물/캐릭터: 등장하는 인물, 역할, 특성
2. 배경/장소: 배경이 되는 장소, 환경
3. 시간/시대: 시간대, 시대 배경
4. 사건/플롯: 주요 사건, 이야기 흐름
5. 주제/테마: 다루는 주제나 테마
6. 분위기/톤: 전반적인 분위기와 톤
7. 감정/어조: 주요 감정이나 어조

각 카테고리가 명확하지 않으면 "없음" 또는 "불명확"이라고 표시하세요.`;

          const res = await fetch(getServerUrl('/api/gpt/chat'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              prompt: `다음 텍스트를 소설 구성 카테고리로 요약해주세요:\n\n${inputText}`,
              systemMessage,
              model: 'gpt-4o-mini',
              temperature: 0.3,
              maxTokens: 1500
            })
          });

          const data = await res.json();
          if (data.ok) {
            const summaryText = data.response || '(응답 없음)';
            $novelSummary.innerHTML = `<div style="white-space: pre-wrap; line-height: 1.6;">${summaryText.replace(/\n/g, '<br>')}</div>`;
            $summaryStatus.textContent = '✓ 요약 완료';
            $summaryStatus.style.color = '#28a745';
            
            // 정리된 데이터를 기록 보기 테이블에 표시 (저장은 안 함)
            displaySummaryData(inputText);
          } else {
            $novelSummary.innerHTML = `<div class="text-danger">오류: ${data.error || '알 수 없는 오류'}</div>`;
            $summaryStatus.textContent = '✗ 요약 실패';
            $summaryStatus.style.color = '#dc3545';
          }
        } catch (e) {
          $novelSummary.innerHTML = `<div class="text-danger">오류: ${e.message}</div>`;
          $summaryStatus.textContent = '✗ 요약 실패';
          $summaryStatus.style.color = '#dc3545';
        } finally {
          $summarizeBtn.disabled = false;
        }
      }

      $summarizeBtn.addEventListener('click', generateSummary);

      // history는 더 이상 사용하지 않음 (GPT 요약 데이터만 표시)

      function computePredictions(text){
        try {
          const arr = (window.wordNbUnicodeFormat || wordNbUnicodeFormat)(text || '');
          $pred.innerHTML = '';
          if (arr.length === 0) return;
          const chip = document.createElement('span');
          chip.className = 'badge bg-secondary me-2 mb-2';
          chip.textContent = `${text.slice(0,1)} (길이 ${text.length})`;
          $pred.appendChild(chip);
        } catch {}
      }

      // GPT 요약 생성 시 테이블에만 표시 (저장 안 함)
      let currentSummaryData = null;

      function displaySummaryData(input){
        const now = Date.now();
        let ascii = [];
        try { ascii = Array.from(input).map(c => c.charCodeAt(0)); } catch {}
        let bit = { max: null, min: null };
        try {
          const arr = (window.wordNbUnicodeFormat || wordNbUnicodeFormat)(input || '');
          bit.max = (window.BIT_MAX_NB || (()=>0))(arr);
          bit.min = (window.BIT_MIN_NB || (()=>0))(arr);
        } catch {}
        currentSummaryData = { t: now, input, ascii, bit, source: 'GPT 정리' };
        renderSummaryData();
      }

      function renderSummaryData(){
        $histBody.innerHTML = '';
        if (currentSummaryData) {
          const tr = document.createElement('tr');
          const h = currentSummaryData;
          const tds = [
            1,
            new Date(h.t).toLocaleString('ko-KR'),
            h.input || '',
            (h.ascii && Array.isArray(h.ascii) ? h.ascii.join(',') : ''),
            (h.bit && h.bit.max != null ? String(h.bit.max) : ''),
            (h.bit && h.bit.min != null ? String(h.bit.min) : ''),
            h.source || ''
          ];
          tds.forEach((v, i) => {
            const td = document.createElement('td');
            td.textContent = String(v || '');
            if (i === 2) {
              td.style.wordBreak = 'break-word';
              td.style.maxWidth = '300px';
            }
            if (i === 3) {
              td.style.wordBreak = 'break-all';
              td.style.fontSize = '0.85em';
            }
            tr.appendChild(td);
          });
          $histBody.appendChild(tr);
          $histInfo.textContent = `기록 1개 (임시 표시 - 저장되지 않음)`;
        } else {
          $histInfo.textContent = `기록 0개`;
        }
      }

      $text.addEventListener('input', () => {
        computePredictions($text.value || '');
        // 자동 저장 제거됨 - GPT 요약 생성 시에만 표시
      });

      $export.addEventListener('click', () => {
        if (!currentSummaryData) {
          alert('표시할 데이터가 없습니다.');
          return;
        }
        const blob = new Blob([JSON.stringify(currentSummaryData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'input_summary.json'; a.click();
        URL.revokeObjectURL(url);
      });
      $clear.addEventListener('click', () => { 
        currentSummaryData = null; 
        renderSummaryData(); 
      });

      // 메모 자동 저장 (서버 데이터베이스)
      const MEMO_ID = 'input_tools_notes'; // 고정 ID 사용
      let memoTimer = null;
      
      const saveMemo = async () => {
        try {
          if ($memoStatus) $memoStatus.textContent = '저장 중...';
          const res = await fetch(getServerUrl(`/api/novels/${encodeURIComponent(MEMO_ID)}/notes`), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: $memo.value || '' })
          });
          const data = await res.json();
          if (data.ok && $memoStatus) {
            $memoStatus.textContent = '저장됨';
          } else {
            if ($memoStatus) $memoStatus.textContent = '저장 실패';
          }
        } catch (e) {
          if ($memoStatus) $memoStatus.textContent = '저장 실패: ' + e.message;
        }
      };
      
      const loadMemo = async () => {
        try {
          const res = await fetch(getServerUrl(`/api/novels/${encodeURIComponent(MEMO_ID)}/notes`));
          const data = await res.json();
          if (data.ok && data.text) {
            $memo.value = data.text;
          }
        } catch (e) {
          console.warn('메모 로드 실패:', e);
        }
      };
      
      $memo.addEventListener('input', () => { 
        if ($memoStatus) $memoStatus.textContent = '저장 중...'; 
        if (memoTimer) clearTimeout(memoTimer); 
        memoTimer = setTimeout(saveMemo, 600); 
      });
      $memo.addEventListener('blur', saveMemo);
      
      // 초기 로드
      loadMemo();
      renderSummaryData();
      computePredictions($text.value || '');
    })();
    </script>
</body>
</html>


